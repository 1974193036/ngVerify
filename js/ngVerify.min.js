/**
 * ngVerify v1.2.0
 *
 * @license: MIT
 * Designed and built by Moer
 * github   https://github.com/Moerj/ngVerify
 *
 */
!function(angular){function formatOpt(str,iElm){"{"!=str.charAt(0)&&(str="{"+str+"}");try{return eval("("+str+")")}catch(e){console.error("ngVerify opts has error:"),console.error(iElm)}}function Init(e){var r=e.ngVerify.$scope,t=e.ngVerify.iAttrs,n=e.ngVerify.OPTS,i={message:"此项为必填",required:!0,option:0,min:t.minlength,max:t.maxlength,errorClass:"verifyError",disabled:!0,least:1,notip:r.ngVerify.notip?r.ngVerify.notip:!1,tipStyle:r.ngVerify.tipStyle?r.ngVerify.tipStyle:1};if("radio"==t.type&&n.least&&(console.warn("least不是radio元素的有效参数!"),console.warn(e),n.least=i.least),n=angular.extend({},i,n),e.ngVerify.OPTS=n,e.attr({maxlength:n.max,minlength:n.min}),n.control||"submit"==t.type)r.ngVerify.subBtn.push(e),angular.element(document).ready(function(){n.disabled&&checkAll(r.ngVerify.elems).hasError&&e.attr("disabled",!0),e.on("click",function(t){t.stopPropagation(),e.attr("disabled")||r.ngVerify.submit()})});else{var a,o="checkbox"==t.type||"radio"==t.type,s="",l='<div class="verifyTips"><p class="tipStyle-'+n.tipStyle+'"><span class="tipMsg"></span><i></i></p></div>',c=e.parent();if(o&&"label"==c[0].localName?(c=c.parent(),c.append(l),a=-1*c[0].offsetHeight):(e.after(l),a=-1*e[0].offsetHeight),e.ngVerify.errtip={container:angular.element(c[0].querySelector(".verifyTips > p")),message:angular.element(c[0].querySelector(".verifyTips .tipMsg"))},1==n.tipStyle){var f=e.ngVerify.errtip.container;f.css("top",a+"px"),"textarea"==e[0].localName&&e.on("click",function(){return f.css("top",-1*e[0].offsetHeight+"px"),!1})}if(s=o?"change":"change keyup",r.ngVerify.elems.push(e),bindVaild(e,s),o)for(var g=document.getElementsByName(t.name),p=0;p<g.length;p++)g[p]!=e[0]&&angular.element(g[p]).on("focus",function(){e.triggerHandler("focus")}).on("blur",function(){e.triggerHandler("blur")}).on(s,function(){e.triggerHandler(s)})}}function bindVaild(e,r){var t=e.ngVerify.$scope,n=e.ngVerify.scope,i=e.ngVerify.iAttrs;i.ngModel&&n.$watch(i.ngModel,function(r,t){(r||t)&&("select"==e[0].localName?r?e.triggerHandler("keyup"):e.triggerHandler("blur"):e.triggerHandler("change"))}),e.on("focus",function(){(e.ngVerify.invalid||e.hasClass(e.ngVerify.OPTS.errorClass))&&tipMsg(e,!0)}).on("blur",function(){ISVALID(e)||(tipMsg(e,!1),makeError(e,!0),DisableButtons(t.ngVerify.subBtn,!0))}).on(r,function(){if(ISVALID(e)){tipMsg(e,!1),makeError(e,!1);var r=checkAll(t.ngVerify.elems);r.hasError||DisableButtons(t.ngVerify.subBtn,!1)}else e.ngVerify.invalid&&tipMsg(e,!0)})}function tipMsg(e,r){var t=e.ngVerify.OPTS;if(!t.notip){var n=e.ngVerify.errtip,i=t.errmsg?t.errmsg:t.message;n.message.text(i),n.container.toggleClass("showTip-"+t.tipStyle,r)}}function makeError(e,r){var t=e.ngVerify.OPTS.errorClass,n=e.parent();e.ngVerify.invalid=r,"checkbox"!=e[0].type&&"radio"!=e[0].type||("label"==n[0].localName&&(n=n.parent()),e=n,e.toggleClass(t+"-dash",r)),e.toggleClass(t,r)}function DisableButtons(e,r){for(var t=0;t<e.length;t++)e[t].ngVerify.OPTS.disabled&&e[t].attr("disabled",r)}function ISVALID(e){if("none"==e[0].style.display)return!0;var r,t=e.val(),n=e.ngVerify.OPTS,i=e.ngVerify.iAttrs;if(void 0==t&&(t=e.text()),t=t.trim(),"checkbox"==i.type||"radio"==i.type){for(var a=e.attr("name"),o=document.getElementsByName(a),s=0,l=0;l<o.length;l++)o[l].checked&&s++;return s>=n.least?!0:(n.message="至少选择"+n.least+"项",!1)}if("select"==e[0].localName)return e[0].selectedIndex===n.option?(n.message="必须选择一项",!1):!0;if(n.required&&""==t)return"number"==i.type?n.message="需输入数字":n.message="不能为空",!1;if(!n.required&&""==t)return!0;if(t.length<n.min)return n.message="最少"+n.min+"个字符",!1;if(n.pattern)r=n.pattern;else switch(i.type){case"number":r=/\d/;break;case"email":r=/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/;break;case"phone":r=/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/;break;case"url":r=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&amp;:\/~\+#]*[\w\-\@?^=%&amp;\/~\+#])?/;break;case"char":r=/^[A-Za-z_]+$/}return r&&null==t.match(r)?(n.message="输入类型错误",!1):!0}function checkAll(e){for(var r={hasError:!1,errEls:[]},t=0;t<e.length;t++)ISVALID(e[t])||r.errEls.push(e[t]);return r.hasError=!!r.errEls.length,r}var m=angular.module("ngVerify",[]);m.provider("ngVerify",function(){this.$get=function(){var e={scope:function(e){for(var r,t=document.getElementsByName(e),n=0;n<t.length;n++)if(t[n]._verifyScope){r=t[n]._verifyScope;break}return r},check:function(r,t){for(var n,i=document.getElementsByName(r),a=0;a<i.length;a++)if(i[a]._verifyScope){var o=e.scope(i[a].name).ngVerify.elems;if(n=checkAll(o),t)for(var s=n.errEls,l=0;l<s.length;l++)makeError(s[l],!0)}return n}};return e}}),m.directive("verifyScope",function(){return{scope:{},controller:function(e,r,t){this.getscope=function(){return e},e.ngVerify={elems:[],subBtn:[],notip:formatOpt(t.verifyScope,r).notip,tipStyle:formatOpt(t.verifyScope,r).tipStyle,submit:function(){for(var r=e.ngVerify.elems,t=checkAll(r),n=0;n<t.errEls.length;n++)makeError(t.errEls[n],!0)}},r[0]._verifyScope=e},link:function(e,r){r.attr("novalidate","novalidate")}}}),m.directive("ngVerify",function(e){return{require:"?^verifyScope",scope:!0,link:function(r,t,n,i){var a,o=formatOpt(n.ngVerify,t);if(void 0!=i)a=i.getscope();else{if(!o.control)return console.log("ngVerify按钮需指向关联的form.name"),void console.error(t);if(a=e.scope(o.control),void 0==a)return console.error("ngVerify按钮找不到关联的表单"),void console.error(t)}t.ngVerify={$scope:a,scope:r,iAttrs:n,OPTS:o},Init(t)}}})}(angular);
